<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重量价值计算器与热敏打印</title>
    <style>
        /* 样式保持不变 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 800px;
            padding: 30px;
            transition: all 0.3s ease;
        }
        
        .container:hover {
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 28px;
            position: relative;
        }
        
        h1:after {
            content: '';
            display: block;
            width: 100px;
            height: 4px;
            background: linear-gradient(to right, #3498db, #2c3e50);
            margin: 10px auto;
            border-radius: 2px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #34495e;
            font-weight: 500;
            font-size: 18px;
        }
        
        input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 18px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn-calculate {
            background: linear-gradient(to right, #3498db, #2c3e50);
            flex: 2;
        }
        
        .btn-reset {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            flex: 1;
        }
        
        .btn-connect {
            background: linear-gradient(to right, #27ae60, #2ecc71);
            flex: 1;
        }
        
        .btn-print {
            background: linear-gradient(to right, #9b59b6, #8e44ad);
            flex: 1;
        }
        
        .btn-fullscreen {
            background: linear-gradient(to right, #f39c12, #e67e22);
            flex: 1;
        }
        
        button {
            color: white;
            border: none;
            border-radius: 10px;
            padding: 14px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .result {
            margin-top: 30px;
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #3498db;
        }
        
        .timestamp {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            background: linear-gradient(to right, #3498db, #2c3e50);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 18px;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: 500;
            color: #495057;
        }
        
        .result-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .highlight {
            color: #e74c3c;
            font-size: 22px;
            font-weight: 700;
        }
        
        .print-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #9b59b6;
            position: relative;
            overflow: hidden;
        }
        
        .print-section:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(to bottom, #9b59b6, #8e44ad);
        }
        
        .print-section h2 {
            color: #8e44ad;
            margin-bottom: 15px;
            font-size: 24px;
        }
        
        .status-bar {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-connected {
            background-color: #2ecc71;
            box-shadow: 0 0 8px #2ecc71;
        }
        
        .status-disconnected {
            background-color: #e74c3c;
        }
        
        .status-text {
            font-weight: 500;
            font-size: 18px;
        }
        
        .log-container {
            margin-top: 15px;
            padding: 15px;
            background-color: #2c3e50;
            color: white;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .gbk-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #f1f8ff;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .gbk-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .gbk-info p {
            color: #34495e;
            line-height: 1.5;
        }
        
        .preview-section {
            margin-top: 20px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .preview-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .print-preview {
            width: 280px;
            min-height: 400px;
            background-color: white;
            margin: 0 auto;
            padding: 15px;
            border: 1px dashed #ccc;
            font-family: monospace;
            font-size: 16px;
            line-height: 1.5;
            white-space: pre;
            overflow: hidden;
            text-align: center;
        }
        
        /* 语音控制区域样式 */
        .voice-control-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .voice-control-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .voice-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 10px 0;
        }
        
        .voice-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #3498db;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .voice-volume {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #volumeSlider {
            width: 120px;
        }
        
        .voice-status {
            padding: 10px;
            background: #e0f7fa;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 16px;
            display: none;
        }
        
        .voice-status.active {
            display: block;
        }
        
        .voice-status.speaking {
            background: #fff8e1;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .timestamp {
                font-size: 20px;
            }
            
            button {
                width: 100%;
            }
            
            .print-preview {
                width: 100%;
            }
            
            .voice-control {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>重量价值计算器与热敏打印</h1>
        
        <div class="form-group">
            <label for="heavy">重车 (公斤):</label>
            <input type="number" id="heavy" placeholder="请输入重车重量" step="0.001" min="0" autofocus>
        </div>
        
        <!-- 修改：将价格输入框放在空车输入框之前 -->
        <div class="form-group">
            <label for="price">单价 (元/斤):</label>
            <input type="number" id="price" placeholder="请输入每斤单价" step="0.001" min="0">
        </div>
        
        <div class="form-group">
            <label for="light">空车 (公斤):</label>
            <input type="number" id="light" placeholder="请输入空车重量" step="0.001" min="0">
        </div>
        
        <div class="buttons">
            <button class="btn-calculate" id="calculateBtn">计算</button>
            <button class="btn-reset" id="resetBtn">归零 (F1)</button>
            <button class="btn-fullscreen" id="fullscreenBtn">全屏模式</button>
        </div>
        
        <div class="result" id="result" style="display: none;">
            <div class="timestamp" id="timestamp"></div>
            <div class="result-item">
                <span class="result-label">重车:</span>
                <span class="result-value" id="result-heavy">0</span> 公斤
            </div>
            <div class="result-item">
                <span class="result-label">空车:</span>
                <span class="result-value" id="result-light">0</span> 公斤
            </div>
            <div class="result-item">
                <span class="result-label">净重:</span>
                <span class="result-value" id="result-net">0</span> 公斤
            </div>
            <div class="result-item">
                <span class="result-label">市斤:</span>
                <span class="result-value" id="result-jin">0</span> 斤
            </div>
            <div class="result-item">
                <span class="result-label">单价:</span>
                <span class="result-value" id="result-price">0</span> 元/斤
            </div>
            <div class="result-item">
                <span class="result-label">总金额:</span>
                <span class="result-value highlight" id="result-total">0</span> 元
            </div>
        </div>
        
        <!-- 语音控制区域 -->
        <div class="voice-control-section">
            <h3>语音播报控制</h3>
            <div class="voice-control">
                <div class="voice-toggle">
                    <span>语音播报:</span>
                    <label class="switch">
                        <input type="checkbox" id="voiceToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="voice-volume">
                    <span>音量:</span>
                    <input type="range" id="volumeSlider" min="0.1" max="1" step="0.1" value="0.8">
                </div>
            </div>
            <div id="voiceStatus" class="voice-status"></div>
        </div>
        
        <div class="print-section">
            <h2>热敏打印功能</h2>
            <div class="status-bar">
                <div class="status-indicator status-disconnected" id="statusIndicator"></div>
                <span class="status-text" id="statusText">未连接打印机</span>
            </div>
            
            <div class="buttons">
                <button class="btn-connect" id="connectBtn">连接打印机</button>
                <button class="btn-print" id="printBtn" disabled>打印结果</button>
            </div>
            
            <div class="log-container" id="logContainer">
                <div class="log-entry">就绪。点击"连接打印机"开始。</div>
            </div>
            
            <div class="preview-section">
                <h3>打印预览 (80mm热敏纸)</h3>
                <div class="print-preview" id="printPreview">
2023-10-15 14:30
重车: 1500 公斤
空车: 800 公斤
净重: 700 公斤
市斤: 1400 斤
单价: 2.50 元/斤
钱: 3500.00
                </div>
            </div>
        </div>
    </div>

    <script>
        // 蓝牙打印机服务UUID和特征UUID
        const PRINT_SERVICE_UUID = '000018f0-0000-1000-8000-00805f9b34fb';
        const PRINT_CHARACTERISTIC_UUID = '00002af1-0000-1000-8000-00805f9b34fb';

        // GBK编码映射表（从原程序提取）
        const gbkMap = {
            "粮": [0xC1, 0xB5],
            "食": [0xCA, 0xB3],
            "收": [0xCA, 0xD5],
            "购": [0xB9, 0xBA],
            "结": [0xBD, 0xE1],
            "算": [0xCB, 0xE3],
            "单": [0xB5, 0xA5],
            "重": [0xD6, 0xD8],
            "量": [0xC1, 0xBF],
            "空": [0xBF, 0xD5],
            "车": [0xB3, 0xB5],
            "净": [0xBE, 0xBB],
            "市": [0xCA, 0xD0],
            "斤": [0xBD, 0xEF],
            "价": [0xBC, 0xDB],
            "钱": [0xC7, 0xAE],
            "应": [0xD3, 0xA6],
            "付": [0xB8, 0xB6],
            "金": [0xBD, 0xF0],
            "额": [0xB6, 0xEE],
            "公": [0xB9, 0xAB],
            "元": [0xD4, 0xAA],
            "时": [0xCA, 0xB1],
            "间": [0xBC, 0xE4],
            "谢": [0xD0, 0xBB],
            "惠": [0xBB, 0xDD],
            "顾": [0xB9, 0xCB],
            "！": [0xA3, 0xA1],
            "：": [0xA3, 0xBA],
            "年": [0xC4, 0xEA],
            "月": [0xD4, 0xC2],
            "日": [0xC8, 0xD5],
            "总": [0xD7, 0xDC],
            "金": [0xBD, 0xF0],
            "额": [0xB6, 0xEE],
            "¥": [0xA5],
            ":": [0x3A],
            "：": [0xA3, 0xBA],
            "=": [0x3D],
            "-": [0x2D]
        };

        // 格式化数字显示，不带小数部分时省略小数
        function formatNumber(num) {
            // 如果是整数，直接返回整数部分
            if (Number.isInteger(num)) {
                return num.toString();
            }
            
            // 否则保留最多3位小数
            return num.toFixed(3).replace(/\.?0+$/, "");
        }

        // 语音助手类
        class SpeechHelper {
            constructor() {
                this.currentUtterance = null;
                this.enabled = true;
                this.volume = 0.8;
                this.chineseVoice = null;
            }
            
            // 启用语音播报
            enable() {
                this.enabled = true;
                updateVoiceStatus("语音播报已启用");
            }
            
            // 禁用语音播报
            disable() {
                this.enabled = false;
                this.stop();
                updateVoiceStatus("语音播报已禁用");
            }
            
            // 设置音量 (0.1 - 1.0)
            setVolume(level) {
                this.volume = Math.max(0.1, Math.min(1.0, level));
                updateVoiceStatus(`音量设置为: ${this.volume}`);
            }
            
            // 停止当前播报
            stop() {
                if (window.speechSynthesis && window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                    updateVoiceStatus("播报已停止");
                }
            }
            
            // 播报文本
            speak(text) {
                if (!this.enabled || !text) return;
                
                if ('speechSynthesis' in window) {
                    // 停止当前播报
                    this.stop();
                    
                    // 创建新的语音对象
                    this.currentUtterance = new SpeechSynthesisUtterance(text);
                    this.currentUtterance.lang = 'zh-CN';
                    this.currentUtterance.volume = this.volume;
                    this.currentUtterance.rate = 1.0;
                    
                    // 查找中文语音
                    if (!this.chineseVoice) {
                        const voices = speechSynthesis.getVoices();
                        if (voices.length > 0) {
                            // 优先选择谷歌中文语音
                            const googleChinese = voices.find(v => 
                                v.name.includes('Google') && v.lang.includes('zh')
                            );
                            this.chineseVoice = googleChinese || 
                                voices.find(v => v.lang.includes('zh'));
                        }
                    }
                    
                    if (this.chineseVoice) {
                        this.currentUtterance.voice = this.chineseVoice;
                    }
                    
                    // 开始播报
                    window.speechSynthesis.speak(this.currentUtterance);
                    
                    // 更新状态
                    updateVoiceStatus(`正在播报: "${text}"`, true);
                    
                    // 播报结束事件
                    this.currentUtterance.onend = () => {
                        updateVoiceStatus("播报完成");
                    };
                } else {
                    updateVoiceStatus("您的浏览器不支持语音合成功能");
                }
            }
            
            // 播报输入的最后一位数字
            speakLastDigit(inputValue) {
                if (!this.enabled || !inputValue || inputValue.length === 0) return;
                
                const lastChar = inputValue.slice(-1);
                
                // 只播报数字，不播报小数点
                if (/[0-9]/.test(lastChar)) {
                    // 数字转换表
                    const numWords = ['零', '一', '二', '三', '四', '五', '六', '七', '八', '九'];
                    const speechText = numWords[parseInt(lastChar)];
                    this.speak(speechText);
                }
            }
        }

        class BluetoothPrinter {
            constructor() {
                this.bluetoothDevice = null;
                this.bluetoothCharacteristic = null;
                this.logCallback = null;
                this.statusCallback = null;
            }

            // 设置日志回调函数
            setLogCallback(callback) {
                this.logCallback = callback;
            }

            // 设置状态更新回调函数
            setStatusCallback(callback) {
                this.statusCallback = callback;
            }

            // 添加日志
            addLog(message) {
                if (this.logCallback) {
                    this.logCallback(message);
                }
            }

            // 更新打印机状态
            updatePrinterStatus(isConnected, deviceName = '') {
                if (this.statusCallback) {
                    this.statusCallback(isConnected, deviceName);
                }
            }

            // 连接蓝牙打印机
            async connectBluetoothPrinter() {
                try {
                    this.addLog("正在寻找蓝牙设备...");
                    
                    // 检查浏览器支持
                    if (!navigator.bluetooth) {
                        throw new Error('您的浏览器不支持Web Bluetooth API。请使用Chrome浏览器。');
                    }
                    
                    // 请求蓝牙设备
                    const device = await navigator.bluetooth.requestDevice({
                        filters: [{ services: [PRINT_SERVICE_UUID] }],
                        optionalServices: [PRINT_SERVICE_UUID]
                    });
                    
                    this.addLog(`找到设备: ${device.name || '未命名设备'}`);
                    
                    // 更新状态为连接中
                    this.updatePrinterStatus(true, "连接中...");
                    this.addLog("正在连接设备...");
                    
                    // 连接到GATT服务器
                    const server = await device.gatt.connect();
                    this.addLog("连接到GATT服务器");
                    
                    // 获取主服务
                    const service = await server.getPrimaryService(PRINT_SERVICE_UUID);
                    this.addLog("找到打印服务");
                    
                    // 获取特性
                    const characteristic = await service.getCharacteristic(PRINT_CHARACTERISTIC_UUID);
                    this.addLog("找到打印特性");
                    
                    // 存储连接信息
                    this.bluetoothDevice = device;
                    this.bluetoothCharacteristic = characteristic;
                    
                    // 更新状态
                    this.updatePrinterStatus(true, device.name || '蓝牙打印机');
                    this.addLog("蓝牙打印机连接成功！");
                    
                    // 监听断开连接事件
                    device.addEventListener('gattserverdisconnected', () => this.onDisconnected());
                    
                    return true;
                } catch (error) {
                    console.error('连接失败:', error);
                    this.addLog(`连接失败: ${error.message || '未知错误'}`);
                    this.updatePrinterStatus(false);
                    throw error;
                }
            }
            
            // 断开连接处理
            onDisconnected() {
                this.addLog("蓝牙连接已断开");
                this.updatePrinterStatus(false);
                this.bluetoothDevice = null;
                this.bluetoothCharacteristic = null;
            }
            
            // 生成打印内容（优化为适合80mm热敏纸）
            generatePrintContent(calculationResult) {
                if (!calculationResult) throw new Error('没有可打印的计算结果');
                
                const { heavy, light, netWeight, jin, price, total } = calculationResult;
                const date = new Date();
                const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                // 使用ESC/POS指令构建打印内容
                let content = '';
                
                // 初始化打印机
                content += '\x1B\x40';
                
                // 设置行间距
                content += '\x1B\x33\x30'; // 设置行间距为30点
                
                // 设置居中
                content += '\x1B\x61\x01';
                
                // 设置2倍字体（宽高各2倍）
                content += '\x1D\x21\x22'; // 设置字体大小（宽2倍+高2倍）
                
                // 日期时间（直接打印，不加前缀）
                content += `${formattedDate}\r\n\r\n`;
                
                // 添加详细信息
                content += `重车: ${formatNumber(heavy)} 公斤\r\n`;
                content += `空车: ${formatNumber(light)} 公斤\r\n`;
                content += `净重: ${formatNumber(netWeight)} 公斤\r\n`;
                content += `市斤: ${formatNumber(jin)} 斤\r\n`;
                content += `单价: ${formatNumber(price)} 元/斤\r\n`;
                content += `钱: ${total.toFixed(2)}\r\n\r\n`;
                
                // 走纸6行 - 增加金额数据和切纸指令之间的间距
                content += '\r\n\r\n\r\n\r\n\r\n\r\n';
                
                // 切纸（如果有切刀功能）
                content += '\x1D\x56\x00';
                
                // 更新预览
                updatePrintPreview(heavy, light, netWeight, jin, price, total, formattedDate);
                
                return content;
            }
            
            // 将字符串转换为GBK编码的Uint8Array
            stringToGbkBytes(str) {
                try {
                    const charArray = str.split('');
                    const gbkBytes = [];
                    
                    for (const char of charArray) {
                        // 特殊处理核心词汇
                        if (gbkMap[char]) {
                            gbkBytes.push(...gbkMap[char]);
                        }
                        // ASCII字符处理
                        else if (char.charCodeAt(0) < 0x80) {
                            gbkBytes.push(char.charCodeAt(0));
                        }
                        // 其他字符使用URL编码方式模拟GBK
                        else {
                            try {
                                const encoded = encodeURIComponent(char);
                                if (encoded.startsWith('%') && encoded.length === 9) {
                                    const byte1 = parseInt(encoded.substr(1, 2), 16);
                                    const byte2 = parseInt(encoded.substr(4, 2), 16);
                                    const byte3 = parseInt(encoded.substr(7, 2), 16);
                                    gbkBytes.push(byte1, byte2, byte3);
                                } else if (encoded.startsWith('%') && encoded.length === 6) {
                                    const byte1 = parseInt(encoded.substr(1, 2), 16);
                                    const byte2 = parseInt(encoded.substr(4, 2), 16);
                                    gbkBytes.push(byte1, byte2);
                                } else {
                                    // 如果出错，使用问号代替
                                    gbkBytes.push(0x3F); // '?'
                                }
                            } catch (e) {
                                // 如果出错，使用问号代替
                                gbkBytes.push(0x3F); // '?'
                            }
                        }
                    }
                    
                    return new Uint8Array(gbkBytes);
                } catch (error) {
                    console.error('GBK编码失败:', error);
                    // 使用TextEncoder作为回退方案
                    const encoder = new TextEncoder();
                    return encoder.encode(str);
                }
            }
            
            // 打印计算结果
            async printResult(calculationResult) {
                if (!this.bluetoothCharacteristic) {
                    throw new Error('请先连接蓝牙打印机');
                }
                
                if (!calculationResult) {
                    throw new Error('请先进行计算');
                }
                
                try {
                    this.addLog("开始打印...");
                    
                    // 生成打印内容
                    const printContent = this.generatePrintContent(calculationResult);
                    this.addLog("打印内容已生成");
                    
                    // 转换为GBK编码
                    const printData = this.stringToGbkBytes(printContent);
                    this.addLog(`数据已编码 (长度: ${printData.length} 字节)`);
                    
                    // 分片发送数据
                    const chunkSize = 20;
                    for (let i = 0; i < printData.length; i += chunkSize) {
                        const chunk = printData.slice(i, i + chunkSize);
                        await this.bluetoothCharacteristic.writeValue(chunk);
                        this.addLog(`已发送数据块: ${i} - ${i + chunk.length}`);
                    }
                    
                    this.addLog("打印任务已发送到打印机");
                    return true;
                } catch (error) {
                    console.error('打印失败:', error);
                    this.addLog(`打印失败: ${error.message}`);
                    throw error;
                }
            }
        }

        // DOM元素引用
        const heavyInput = document.getElementById('heavy');
        const lightInput = document.getElementById('light');
        const priceInput = document.getElementById('price');
        const calculateBtn = document.getElementById('calculateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const connectBtn = document.getElementById('connectBtn');
        const printBtn = document.getElementById('printBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const resultDiv = document.getElementById('result');
        const timestampDiv = document.getElementById('timestamp');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const logContainer = document.getElementById('logContainer');
        const printPreview = document.getElementById('printPreview');
        const voiceToggle = document.getElementById('voiceToggle');
        const volumeSlider = document.getElementById('volumeSlider');
        const voiceStatus = document.getElementById('voiceStatus');
        
        // 初始化蓝牙打印机
        const printer = new BluetoothPrinter();
        let calculationResult = null;
        let canPrint = false; // 新增状态变量，用于跟踪是否可以打印
        
        // 创建语音助手实例
        const speechHelper = new SpeechHelper();
        
        // 设置打印机的回调函数
        printer.setLogCallback(function(message) {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = message;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        });
        
        printer.setStatusCallback(function(isConnected, deviceName) {
            if (isConnected) {
                statusIndicator.className = 'status-indicator status-connected';
                statusText.textContent = deviceName ? `已连接: ${deviceName}` : '已连接';
                printBtn.disabled = false;
            } else {
                statusIndicator.className = 'status-indicator status-disconnected';
                statusText.textContent = '未连接打印机';
                printBtn.disabled = true;
            }
        });
        
        // 更新语音状态显示
        function updateVoiceStatus(message, isSpeaking = false) {
            voiceStatus.textContent = message;
            voiceStatus.className = 'voice-status active';
            if (isSpeaking) {
                voiceStatus.classList.add('speaking');
            } else {
                voiceStatus.classList.remove('speaking');
            }
        }
        
        // 事件绑定
        document.addEventListener('DOMContentLoaded', function() {
            // 设置焦点到重车输入框
            heavyInput.focus();
            
            // 绑定按钮点击事件
            calculateBtn.addEventListener('click', calculate);
            resetBtn.addEventListener('click', resetCalculator);
            connectBtn.addEventListener('click', connectPrinter);
            printBtn.addEventListener('click', printCalculationResult);
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            
            // 绑定输入框回车键事件 - 修改后的导航逻辑
            heavyInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    priceInput.focus(); // 重车回车后跳转到单价输入框
                }
            });
            
            priceInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    lightInput.focus(); // 单价回车后跳转到空车输入框
                }
            });
            
            lightInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    calculate(); // 空车回车后触发计算
                }
            });
            
            // 绑定输入框输入事件（语音播报）
            heavyInput.addEventListener('input', function() {
                speechHelper.speakLastDigit(this.value);
            });
            
            lightInput.addEventListener('input', function() {
                speechHelper.speakLastDigit(this.value);
            });
            
            priceInput.addEventListener('input', function() {
                speechHelper.speakLastDigit(this.value);
            });
            
            // 语音开关事件
            voiceToggle.addEventListener('change', function(e) {
                if (e.target.checked) {
                    speechHelper.enable();
                } else {
                    speechHelper.disable();
                }
            });
            
            // 音量控制事件
            volumeSlider.addEventListener('input', function(e) {
                speechHelper.setVolume(parseFloat(e.target.value));
            });
            
            // 新增：全局回车键监听
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    // 如果计算结果存在且打印按钮可用
                    if (canPrint && calculationResult && !printBtn.disabled) {
                        printCalculationResult();
                    }
                }
            });
            
            // 新增：F1键监听（归零功能）
            document.addEventListener('keydown', function(e) {
                // F1键的keyCode是112
                if (e.key === 'F1' || e.keyCode === 112) {
                    e.preventDefault(); // 阻止浏览器默认的F1帮助功能
                    resetCalculator(); // 执行归零操作
                    
                    // 语音提示
                    speechHelper.speak("已归零");
                }
            });
        });
        
        // 更新打印预览
        function updatePrintPreview(heavy, light, netWeight, jin, price, total, date) {
            const previewContent = 
`${date}
重车: ${formatNumber(heavy)} 公斤
空车: ${formatNumber(light)} 公斤
净重: ${formatNumber(netWeight)} 公斤
市斤: ${formatNumber(jin)} 斤
单价: ${formatNumber(price)} 元/斤
钱: ${total.toFixed(2)}`;
            
            printPreview.textContent = previewContent;
        }
        
        // 全屏模式切换
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`全屏请求错误: ${err.message}`);
                });
                fullscreenBtn.textContent = "退出全屏";
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    fullscreenBtn.textContent = "全屏模式";
                }
            }
        }
        
        function calculate() {
            // 获取输入值
            const heavy = parseFloat(heavyInput.value);
            const light = parseFloat(lightInput.value);
            const price = parseFloat(priceInput.value);
            
            // 验证输入
            if (isNaN(heavy) || isNaN(light) || isNaN(price)) {
                alert("请输入有效的数值！");
                return;
            }
            
            if (heavy <= light) {
                alert("重车必须大于空车！");
                return;
            }
            
            // 计算净重（公斤）
            const netWeight = heavy - light;
            
            // 转换为市斤（1公斤 = 2市斤）
            const jin = netWeight * 2;
            
            // 计算总金额
            const total = jin * price;
            
            // 存储计算结果
            calculationResult = {
                heavy,
                light,
                netWeight,
                jin,
                price,
                total
            };
            
            // 获取当前时间
            const now = new Date();
            const timestamp = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(/\//g, '-');
            
            // 显示时间
            timestampDiv.textContent = timestamp;
            
            // 显示结果（不四舍五入）
            document.getElementById('result-heavy').textContent = formatNumber(heavy);
            document.getElementById('result-light').textContent = formatNumber(light);
            document.getElementById('result-net').textContent = formatNumber(netWeight);
            document.getElementById('result-jin').textContent = formatNumber(jin);
            document.getElementById('result-price').textContent = formatNumber(price);
            document.getElementById('result-total').textContent = total.toFixed(2);
            
            // 显示结果区域
            resultDiv.style.display = 'block';
            
            // 更新打印预览
            updatePrintPreview(heavy, light, netWeight, jin, price, total, timestamp);
            
            // 新增：设置可以打印的状态
            canPrint = true;
            
            // 新增：提示用户按回车打印
            printer.addLog("计算完成！按回车键可打印结果");
            
            // 语音播报计算结果
            const totalText = `总金额：${total.toFixed(2)}元`;
            speechHelper.speak(totalText);
            
            // 新增：滚动到结果区域
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function resetCalculator() {
            // 清空所有输入框的值
            heavyInput.value = '';
            lightInput.value = '';
            priceInput.value = '';
            
            // 隐藏结果区域
            resultDiv.style.display = 'none';
            
            // 清除计算结果
            calculationResult = null;
            
            // 将焦点设置到重车输入框
            heavyInput.focus();
            
            // 重置预览
            printPreview.textContent = `2023-10-15 14:30
重车: 1500 公斤
空车: 800 公斤
净重: 700 公斤
市斤: 1400 斤
单价: 2.50 元/斤
钱: 3500.00`;
            
            // 新增：重置打印状态
            canPrint = false;
        }
        
        async function connectPrinter() {
            try {
                connectBtn.disabled = true;
                connectBtn.textContent = "连接中...";
                await printer.connectBluetoothPrinter();
            } catch (error) {
                alert(`连接失败: ${error.message}`);
            } finally {
                connectBtn.disabled = false;
                connectBtn.textContent = "连接打印机";
            }
        }
        
        async function printCalculationResult() {
            if (!calculationResult) {
                alert("请先进行计算");
                return;
            }
            
            try {
                printBtn.disabled = true;
                printBtn.textContent = "打印中...";
                await printer.printResult(calculationResult);
                
                // 新增：打印完成后重置状态
                canPrint = false;
            } catch (error) {
                alert(`打印失败: ${error.message}`);
            } finally {
                printBtn.disabled = false;
                printBtn.textContent = "打印结果";
            }
        }
        
        // 初始化语音引擎
        window.speechSynthesis.getVoices();
    </script>
</body>
</html>